$bp = 0;
$payment = 0;
$sql = "select round(((/* net */ (select sum(round((tra_item_gprice - (tra_item_gprice*(case when datediff(now(),tra_due)>0 and datediff(now(),tra_due)<=7 then case when tra_vat>1 then tra_item_discount else tra_item_discount - 5 end when datediff(now(),tra_due)>7 and datediff(now(),tra_due)<=14 then tra_item_discount - 10 when datediff(now(),tra_due)>14 and datediff(now(),tra_due)<=21 then tra_item_discount - 15 when datediff(now(),tra_due)>21 then tra_item_discount - tra_item_discount else tra_item_discount end/100))) * (tra_item_qty - ifnull((select sum(dret_qty) from dealers_returns where dret_tino = tra_item_no),0)),2)) from transaction_items where tra_item_trano = tra_no) /* <- */ - /* net/vat*avon discount */ (select sum(round((tra_item_gprice - (tra_item_gprice*(case when datediff(now(),tra_due)>0 and datediff(now(),tra_due)<=7 then case when tra_vat>1 then tra_item_discount else tra_item_discount - 5 end when datediff(now(),tra_due)>7 and datediff(now(),tra_due)<=14 then tra_item_discount - 10 when datediff(now(),tra_due)>14 and datediff(now(),tra_due)<=21 then tra_item_discount - 15 when datediff(now(),tra_due)>21 then tra_item_discount - tra_item_discount else tra_item_discount end/100))) * (tra_item_qty - ifnull((select sum(dret_qty) from dealers_returns where dret_tino = tra_item_no),0)),2)) from transaction_items where tra_item_trano = tra_no)/case when datediff(now(),tra_due)>0 then case when tra_vat>1 then 1 else tra_vat end else tra_vat end*(case when datediff(now(),tra_due)>0 then tra_avond - tra_avond else tra_avond end/100) /* <- */) - /* net/vat*avon discount*cash discount  */ ((/* net */ (select sum(round((tra_item_gprice - (tra_item_gprice*(case when datediff(now(),tra_due)>0 and datediff(now(),tra_due)<=7 then case when tra_vat>1 then tra_item_discount else tra_item_discount - 5 end when datediff(now(),tra_due)>7 and datediff(now(),tra_due)<=14 then tra_item_discount - 10 when datediff(now(),tra_due)>14 and datediff(now(),tra_due)<=21 then tra_item_discount - 15 when datediff(now(),tra_due)>21 then tra_item_discount - tra_item_discount else tra_item_discount end/100))) * (tra_item_qty - ifnull((select sum(dret_qty) from dealers_returns where dret_tino = tra_item_no),0)),2)) from transaction_items where tra_item_trano = tra_no) /* <- */ - /* net/vat*avon discount */ (select sum(round((tra_item_gprice - (tra_item_gprice*(case when datediff(now(),tra_due)>0 and datediff(now(),tra_due)<=7 then case when tra_vat>1 then tra_item_discount else tra_item_discount - 5 end when datediff(now(),tra_due)>7 and datediff(now(),tra_due)<=14 then tra_item_discount - 10 when datediff(now(),tra_due)>14 and datediff(now(),tra_due)<=21 then tra_item_discount - 15 when datediff(now(),tra_due)>21 then tra_item_discount - tra_item_discount else tra_item_discount end/100))) * (tra_item_qty - ifnull((select sum(dret_qty) from dealers_returns where dret_tino = tra_item_no),0)),2)) from transaction_items where tra_item_trano = tra_no)/case when datediff(now(),tra_due)>0 then case when tra_vat>1 then 1 else tra_vat end else tra_vat end*(case when datediff(now(),tra_due)>0 then tra_avond - tra_avond else tra_avond end/100) /* <- */)*(tra_cashd/100))),2) balance_penalty from transactions where tra_no = $tid";
db_connect();
$rs = $db_con->query($sql);
$rec = $rs->fetch_array();
$bp = $rec['balance_penalty'];
db_close();

$sql = "select round(sum(ifnull(payment_amount,0)),2) payment from receipt_payments where payment_transaction_no = $tid";
db_connect();
$rs = $db_con->query($sql);
$rec = $rs->fetch_array();
$bp = $rec['payment'];
db_close();